workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
  - test

semgrep:
  stage: test
  image: python:3.11
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install requests semgrep
    - git fetch --all
    - echo '$SEMGREP_APP_TOKEN'
    - export BASE_COMMIT=$(git merge-base origin/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME)
    - semgrep scan --metrics=off --config p/ci --json --baseline-commit $BASE_COMMIT > findings.json
    - python gitlab_comments.py
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    SEMGREP_APP_TOKEN: '$SEMGREP_APP_TOKEN'

# 
#
# workflow:
#
#
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# stages:
#   - test

# semgrep:
#   stage: test
#   image: semgrep/semgrep
#   script:
#     - semgrep ci --dataflow-traces
#   rules:
#     - if: $CI_MERGE_REQUEST_IID
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#   variables:
#     SEMGREP_APP_TOKEN: $SEMGREP_APP_TOKEN
# workflow:
#   rules:
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#workflow:
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#    - if: '$CI_COMMIT_BRANCH == "main"'

#job1:
#  script:
#    - echo "This job runs in merge request pipelines $CI_PIPELINE_SOURCE $CI_COMMIT_BRANCH $CI_DEFAULT_BRANCH"
