workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
  - test

semgrep:
  stage: test
  image: python:3.11
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install requests semgrep
    - semgrep --baseline-commit HEAD~ --json > findings.json
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    SEMGREP_APP_TOKEN: $SEMGREP_APP_TOKEN

# workflow:
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# stages:
#   - test

# semgrep:
#   stage: test
#   image: semgrep/semgrep
#   script:
#     - semgrep ci --dataflow-traces
#   rules:
#     - if: $CI_MERGE_REQUEST_IID
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#   variables:
#     SEMGREP_APP_TOKEN: $SEMGREP_APP_TOKEN
# workflow:
#   rules:
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#workflow:
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#    - if: '$CI_COMMIT_BRANCH == "main"'

#job1:
#  script:
#    - echo "This job runs in merge request pipelines $CI_PIPELINE_SOURCE $CI_COMMIT_BRANCH $CI_DEFAULT_BRANCH"
